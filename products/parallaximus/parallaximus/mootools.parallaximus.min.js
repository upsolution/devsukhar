/*
 * Parallaximus
 *
 * @version 1.0
 *
 * Copyright 2013, Ruslan Sukhar
 */

var Parallaximus=new Class({Extends:Fx,options:{link:false,fps:30,use3d:true,perspective:400,angleXRange:10,angleYRange:10,basePoint:[.5,.5],duration:2e3,transition:Fx.Transitions.Elastic.easeOut,resizeDelay:50},initialize:function(e,t){this.container=document.id(e);if(e.onclick!=undefined){t=Object.merge(e.onclick()||{},typeof t=="object"&&t);e.erase("onclick")}this.parent(t);this.layers=this.container.getChildren();this.baseCntSz=this.container.getSize();this.baseLayerSz=this.layers.getSize();this.baseImgSz=[];Array.each(this.layers,function(e,t){this.baseImgSz[t]=e.getElements("img").getStyles(["left","top","width","height"])},this);this.curCntSz=Object.clone(this.baseCntSz);this.curLayerSz=this.baseLayerSz.clone();this._countRatios();if(this.options.use3d){this.cssPrefix=this._get3DPrefix();if(this.cssPrefix===false)this.options.use3d=false}this._frameRate=Math.round(1e3/this.options.fps);if(!("ontouchstart"in window)||!("DeviceOrientationEvent"in window)){this.container.addEvents({mousemove:function(e){var t=this.container.getPosition(),n=Date.now();if(this._lastFrame+this._frameRate>n)return;this.stop().set([(e.page.x-t.x)/this.curCntSz.x,(e.page.y-t.y)/this.curCntSz.y]);this._lastFrame=n}.bind(this),mouseout:function(e){this.start(this.options.basePoint.clone())}.bind(this)})}if("ontouchstart"in window&&"DeviceOrientationEvent"in window){window.addEventListener("deviceorientation",function(e){var t=Date.now();if(this._lastFrame+this._frameRate>t)return;this._deviceOrientationChange(e);this._lastFrame=t}.bind(this))}if(this.options.link!==false){this.container.addEvent("click",function(e){location.href=this.options.link}.bind(this)).setStyle("cursor","pointer")}this.set(this.options.basePoint);if(!this.container.hasClass("width_fixed")){window.addEvent("resize",function(){clearTimeout(this._resizeTimer);this._resizeTimer=this._handleResize.delay(this.options.resizeDelay,this)}.bind(this));this.container.setStyle("width","100%");this._handleResize()}this._lastFrame=Date.now()},_get3DPrefix:function(){var e=document.createElement("div"),t=false,n=["perspectiveProperty","WebkitPerspective"],r=["","-o-","-moz-","-webkit-"];for(var i=n.length-1;i>=0;i--)t=t?t:e.style[n[i]]!=undefined;if(t){var s=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(s);e.id="test3d";document.body.appendChild(e);for(var o in r){s.textContent="@media ("+r[o]+"transform-3d){#test3d{height:3px}}";if(e.offsetHeight===3){t=r[o];break}}s.parentNode.removeChild(s);e.parentNode.removeChild(e)}return t},_deviceOrientationChange:function(e){var t=e.gamma,n=e.beta,r;switch(window.orientation){case-90:t=Math.max(-45,Math.min(45,t-20));n=Math.max(-45,Math.min(45,n));r=[(45-n)/90,(t+45)/90];r=[(n+45)/90,(45-t)/90];break;case 90:t=Math.max(-45,Math.min(45,t+20));n=Math.max(-45,Math.min(45,n));r=[(45-n)/90,(t+45)/90];break;case 180:t=Math.max(-45,Math.min(45,t));n=Math.max(-45,Math.min(45,n+20));r=[(t+45)/90,(n+45)/90];break;case 0:default:if(t<-90||t>90)t=Math.abs(e.gamma)/e.gamma*(180-Math.abs(e.gamma));t=Math.max(-45,Math.min(45,t));n=Math.max(-45,Math.min(45,n-20));r=[(45-t)/90,(45-n)/90];break}this.stop().set(r)},_handleResize:function(){this.curCntSz=this.container.getSize();var e=this.curCntSz.x/this.baseCntSz.x,t=!this.container.hasClass("height_fixed"),n=["width","height","left","top"];for(var r=0,i=this.layers.length;r<i;r++){var s=this.layers[r],o=s.getElements("img");this.curLayerSz[r].x=this.baseLayerSz[r].x*e;s.setStyle("width",this.curLayerSz[r].x);if(t){this.curLayerSz[r].y=this.baseLayerSz[r].y*e;s.setStyle("height",this.curLayerSz[r].y)}Array.each(o,function(i,s){if(t){Array.each(n,function(t){i.setStyle(t,parseInt(this.baseImgSz[r][s][t])*e)},this)}else{var o=parseInt(this.baseImgSz[r][s].width)/2,u=parseInt(this.baseImgSz[r][s].left)+o;i.setStyle("left",u*e-o)}},this)}if(t){this.curCntSz.y=this.baseCntSz.y*e;this.container.setStyle("height",this.curCntSz.y)}this.curLayerSz=this.layers.getSize();this._countRatios();this.set(this.now)},_countRatios:function(){this.layerAngle=[];this.layerMin=[];this.layerRatio=[];for(var e=0,t=this.layers.length;e<t;e++){var n=this.curLayerSz[e];this.layerAngle[e]={x:-1*this.options.angleXRange*(e+1)/this.layers.length,y:this.options.angleYRange*(e+1)/this.layers.length};this.layerMin[e]={x:0,y:0};if(this.curCntSz.x<this.curLayerSz[e].x){this.layerMin[e].x=.5*this.curLayerSz[e].x*(1-Math.cos(this.layerAngle[e].x/180*Math.PI))}if(this.curCntSz.y<this.curLayerSz[e].y){this.layerMin[e].y=.5*this.curLayerSz[e].y*(1-Math.cos(this.layerAngle[e].y/180*Math.PI))}this.layerRatio[e]={x:this.curCntSz.x-this.curLayerSz[e].x-2*this.layerMin[e].x,y:this.curCntSz.y-this.curLayerSz[e].y-2*this.layerMin[e].y}}},set:function(e){Array.each(this.layers,function(t,n){t.setStyle("left",this.layerMin[n].x+this.layerRatio[n].x*e[0]).setStyle("top",this.layerMin[n].y+this.layerRatio[n].y*e[1]);if(this.options.use3d){t.setStyle(this.cssPrefix+"transform","perspective("+this.options.perspective+"px) "+"rotateX("+this.layerAngle[n].y*(e[1]-.5)+"deg) "+"rotateY("+this.layerAngle[n].x*(e[0]-.5)+"deg)")}},this);this.now=e.clone();return this},compute:function(e,t,n){return[(t[0]-e[0])*n+e[0],(t[1]-e[1])*n+e[1]]},start:function(e){this.parent(this.now,e);return this}});window.addEvent("domready",function(){Array.each(document.getElements(".w-parallaximus.i-autoinit"),function(e){e.store("parallaximus",new Parallaximus(e))})});
