/*
 * Parallaximus
 *
 * @version 1.0
 *
 * Copyright 2013, Ruslan Sukhar
 */

!function(e){var t=function(t,n){var r=this;this.container=e(t);if(t.onclick!=undefined){n=e.extend({},t.onclick()||{},typeof n=="object"&&n);this.container.removeProp("onclick")}n=e.extend({},e.fn.parallaximus.defaults,typeof n=="object"&&n);this.options=n;this.layers=this.container.children();this.baseCntSz={x:this.container.width(),y:this.container.height()};this.baseLayerSz=this._getLayerSizes();this.baseImgSz=[];this.layers.each(function(t,n){r.baseImgSz[t]=[];e(n).find("img").each(function(n,i){r.baseImgSz[t][n]=e(i).css(["left","top","width","height"])})});this.curCntSz=e.extend({},this.baseCntSz);this.curLayerSz=e.extend(true,[],this.baseLayerSz);this._countRatios();if(this.options.use3d){this.cssPrefix=this._get3DPrefix();if(this.cssPrefix===false)this.options.use3d=false}this._frameRate=Math.round(1e3/this.options.fps);if(!("ontouchstart"in window)||!("DeviceOrientationEvent"in window)){this.container.mousemove(function(e){var t=r.container.offset(),n=Date.now();if(r._lastFrame+r._frameRate>n)return;r.container.stop(true,true);r.set([(e.pageX-t.left)/r.curCntSz.x,(e.pageY-t.top)/r.curCntSz.y]);r._lastFrame=n}).mouseleave(function(t){var n=e.extend({},r.now),i=r.options.basePoint;r.container.css("delta",0).animate({delta:1},{duration:r.options.duration,easing:r.options.transition,step:function(e){r.set([(i[0]-n[0])*e+n[0],(i[1]-n[1])*e+n[1]])},queue:false})})}if("ontouchstart"in window&&"DeviceOrientationEvent"in window){window.addEventListener("deviceorientation",function(e){var t=Date.now();if(r._lastFrame+r._frameRate>t)return;r._deviceOrientationChange(e);r._lastFrame=t})}if(this.options.link!==false){this.container.click(function(e){location.href=r.options.link}).css("cursor","pointer")}this.set(this.options.basePoint);if(!this.container.hasClass("width_fixed")){e(window).resize(function(){clearTimeout(this._resizeTimer);this._resizeTimer=setTimeout(function(){r._handleResize()},r.options.resizeDelay)});this.container.css("width","100%");this._handleResize()}this._lastFrame=Date.now()};t.prototype={_getLayerSizes:function(){var t=[];this.layers.each(function(n,r){t[n]={x:e(r).width(),y:e(r).height()}});return t},_get3DPrefix:function(){var e=document.createElement("div"),t=false,n=["perspectiveProperty","WebkitPerspective"],r=["","-o-","-moz-","-webkit-"];for(var i=n.length-1;i>=0;i--)t=t?t:e.style[n[i]]!=undefined;if(t){var s=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(s);e.id="test3d";document.body.appendChild(e);for(var o in r){s.textContent="@media ("+r[o]+"transform-3d){#test3d{height:3px}}";if(e.offsetHeight===3){t=r[o];break}}s.parentNode.removeChild(s);e.parentNode.removeChild(e)}return t},_deviceOrientationChange:function(e){var t=e.gamma,n=e.beta,r;switch(window.orientation){case-90:t=Math.max(-45,Math.min(45,t-20));n=Math.max(-45,Math.min(45,n));r=[(45-n)/90,(t+45)/90];r=[(n+45)/90,(45-t)/90];break;case 90:t=Math.max(-45,Math.min(45,t+20));n=Math.max(-45,Math.min(45,n));r=[(45-n)/90,(t+45)/90];break;case 180:t=Math.max(-45,Math.min(45,t));n=Math.max(-45,Math.min(45,n+20));r=[(t+45)/90,(n+45)/90];break;case 0:default:if(t<-90||t>90)t=Math.abs(e.gamma)/e.gamma*(180-Math.abs(e.gamma));t=Math.max(-45,Math.min(45,t));n=Math.max(-45,Math.min(45,n-20));r=[(45-t)/90,(45-n)/90];break}this.container.stop(true,true);this.set(r)},_handleResize:function(){this.curCntSz={x:this.container.width(),y:this.container.height()};var t=this.curCntSz.x/this.baseCntSz.x,n=!this.container.hasClass("height_fixed"),r=["width","height","left","top"],i=this;for(var s=0,o=this.layers.length;s<o;s++){var u=e(this.layers[s]),a=u.find("img");this.curLayerSz[s].x=this.baseLayerSz[s].x*t;u.css("width",this.curLayerSz[s].x);if(n){this.curLayerSz[s].y=this.baseLayerSz[s].y*t;u.css("height",this.curLayerSz[s].y)}for(var f=0,l=a.length;f<l;f++){var c=e(a[f]);if(n){for(var h in r){var p=r[h];c.css(p,parseInt(this.baseImgSz[s][f][p])*t)}}else{var d=parseInt(this.baseImgSz[s][f].width)/2,v=parseInt(this.baseImgSz[s][f].left)+d;c.css("left",v*t-d)}}}if(n){this.curCntSz.y=this.baseCntSz.y*t;this.container.css("height",this.curCntSz.y)}this.curLayerSz=this._getLayerSizes();this._countRatios();this.set(this.now)},_countRatios:function(){this.layerAngle=[];this.layerMin=[];this.layerRatio=[];for(var e=0,t=this.layers.length;e<t;e++){var n=this.curLayerSz[e];this.layerAngle[e]={x:-1*this.options.angleXRange*(e+1)/this.layers.length,y:this.options.angleYRange*(e+1)/this.layers.length};this.layerMin[e]={x:0,y:0};if(this.curCntSz.x<this.curLayerSz[e].x){this.layerMin[e].x=.5*this.curLayerSz[e].x*(1-Math.cos(this.layerAngle[e].x/180*Math.PI))}if(this.curCntSz.y<this.curLayerSz[e].y){this.layerMin[e].y=.5*this.curLayerSz[e].y*(1-Math.cos(this.layerAngle[e].y/180*Math.PI))}this.layerRatio[e]={x:this.curCntSz.x-this.curLayerSz[e].x-2*this.layerMin[e].x,y:this.curCntSz.y-this.curLayerSz[e].y-2*this.layerMin[e].y}}},set:function(t){for(var n=0,r=this.layers.length;n<r;n++){var i=e(this.layers[n]);i.css("left",this.layerMin[n].x+this.layerRatio[n].x*t[0]).css("top",this.layerMin[n].y+this.layerRatio[n].y*t[1]);if(this.options.use3d){i.css(this.cssPrefix+"transform","perspective("+this.options.perspective+"px) "+"rotateX("+this.layerAngle[n].y*(t[1]-.5)+"deg) "+"rotateY("+this.layerAngle[n].x*(t[0]-.5)+"deg)")}}this.now=t.slice();return this}};if(e.easing.easeOutElastic==undefined){e.easing.easeOutElastic=function(e,t,n,r,i){var s=1.70158,o=0,u=r;if(t==0)return n;if((t/=i)==1)return n+r;if(!o)o=i*.3;if(u<Math.abs(r)){u=r;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(r/u);return u*Math.pow(2,-10*t)*Math.sin((t*i-s)*2*Math.PI/o)+r+n}}e.fn.parallaximus=function(n){return this.each(function(){var r=e(this),i=r.data("parallaximus");if(!i)r.data("parallaximus",i=new t(this,n))})};e.fn.parallaximus.defaults={link:false,fps:30,use3d:true,perspective:400,angleXRange:10,angleYRange:10,basePoint:[.5,.5],duration:2e3,transition:"easeOutElastic",resizeDelay:50};e.fn.parallaximus.Constructor=t}(jQuery);jQuery(document).ready(function(e){jQuery(".w-parallaximus.i-autoinit").parallaximus()})
